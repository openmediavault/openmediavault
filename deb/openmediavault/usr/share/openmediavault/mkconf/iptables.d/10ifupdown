#!/bin/sh
#
# This file is part of OpenMediaVault.
#
# @license   http://www.gnu.org/licenses/gpl.html GPL Version 3
# @author    Volker Theile <volker.theile@openmediavault.org>
# @copyright Copyright (c) 2009-2020 Volker Theile
#
# OpenMediaVault is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# OpenMediaVault is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with OpenMediaVault. If not, see <http://www.gnu.org/licenses/>.

# Documentation/Howto:
# https://help.ubuntu.com/community/IptablesHowTo
# http://www.linuxhomenetworking.com/wiki/index.php/Quick_HOWTO_:_Ch14_:_Linux_Firewalls_Using_iptables
# http://www.cyberciti.biz/tips/linux-iptables-how-to-specify-a-range-of-ip-addresses-or-ports.html
# http://manpages.debian.org/cgi-bin/man.cgi?query=iptables&apropos=0&sektion=0&manpath=Debian+7.8+wheezy&format=html&locale=en

set -e

. /etc/default/openmediavault
. /usr/share/openmediavault/scripts/helper-functions

OMV_IPTABLES_CONFIG=${OMV_IPTABLES_CONFIG:-"/etc/network/if-pre-up.d/openmediavault-iptables"}

cat <<EOF > ${OMV_IPTABLES_CONFIG}
#!/bin/sh
# This configuration file is auto-generated.
# WARNING: Do not edit this file, your changes will be lost.

set -e

# Make sure that only one instance of this shell script is running at
# the same time.
LOCK_FILE=/run/openmediavault-iptables.lock
if ! mkdir "\${LOCK_FILE}"; then
	echo "Locking failed, another job is running"
	exit 0
fi
trap "rm -rf \${LOCK_FILE}" 0 1 2 3 5 15

EOF

xmlstarlet sel -t \
  -i "count(//system/network/iptables/rule[family='inet']) > 0" \
	  -o "iptables -t filter -F INPUT" -n \
	  -o "iptables -t filter -F OUTPUT" -n \
  -b \
  -i "count(//system/network/iptables/rule[family='inet6']) > 0" \
	  -o "ip6tables -t filter -F INPUT" -n \
	  -o "ip6tables -t filter -F OUTPUT" -n \
  -b \
  -m "//system/network/iptables/rule" -s A:T:L family -s A:N:L rulenum \
	  -i "family='inet'" -o "iptables" -b \
	  -i "family='inet6'" -o "ip6tables" -b \
	  -v "concat(' -A ',chain)" \
	  -i "starts-with(protocol,'!')" \
		  -v "concat(' ! -p ',translate(protocol,'!',''))" \
	  -b \
	  -i "not(starts-with(protocol,'!'))" \
		  -v "concat(' -p ',protocol)" \
	  -b \
	  -i "string-length(source) > 0" \
		  -i "contains(source,'-')" \
			  -o " -m iprange" \
			  -i "starts-with(source,'!')" -o " !" -b \
			  -o " --src-range " \
			  -v "translate(source,'!','')" \
		  -b \
		  -i "not(contains(source,'-'))" \
			  -i "starts-with(source,'!')" -o " !" -b \
			  -o " --source " \
			  -v "translate(source,'!','')" \
		  -b \
	  -b \
	  -i "string-length(sport) > 0" \
		  -i "starts-with(sport,'!')" -o " !" -b \
		  -o " --sport " \
		  -v "translate(translate(sport,'!',''),'-',':')" \
	  -b \
	  -i "string-length(destination) > 0" \
		  -i "contains(destination,'-')" \
			  -o " -m iprange" \
			  -i "starts-with(destination,'!')" -o " !" -b \
			  -o " --dst-range " \
			  -v "translate(destination,'!','')" \
		  -b \
		  -i "not(contains(destination,'-'))" \
			  -i "starts-with(destination,'!')" -o " !" -b \
			  -o " --destination " \
			  -v "translate(destination,'!','')" \
		  -b \
	  -b \
	  -i "string-length(dport) > 0" \
		  -i "starts-with(dport,'!')" -o " !" -b \
		  -o " --dport " \
		  -v "translate(translate(dport,'!',''),'-',':')" \
	  -b \
	  -i "string-length(action) > 0" \
		  -v "concat(' -j ',action)" \
	  -b \
	  -i "string-length(extraoptions) > 0" -v "concat(' ',extraoptions)" -b \
	  -n \
  -b \
  ${OMV_CONFIG_FILE} | xmlstarlet unesc >> ${OMV_IPTABLES_CONFIG}

chmod 750 ${OMV_IPTABLES_CONFIG}
